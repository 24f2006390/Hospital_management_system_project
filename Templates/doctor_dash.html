{% extends 'base.html' %}

{% block body %}

<h2 class="text-center">Doctor dashboard </h2>
<h2> User Name : {{user_name }}</h2>



<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#appointment_modal">
    Provide Availability
</button>


<div class="modal fade" id="appointment_modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}

<script>
    const availability  = {{ availability | tojson }} ; 
    console.log(availability)
    const modal = document.querySelector('#appointment_modal');


    const modal_body = document.querySelector('.modal-body')
    const container = document.createElement('div')
    container.classList.add('container')

    const next_Days = 7;
    let date = new Date();
   
    for (let i = 0; i < next_Days; i++) {
        const row = document.createElement('div')
        row.classList.add('row', 'mb-3')

        const TextContent = ['8 to 12', '4 to 9']
        

        // First Date Element 
        const col = document.createElement('div')
        col.classList.add('col')
        const button = document.createElement('button')
        button.classList.add('btn', 'btn-secondary', 'container')

        date.setDate(date.getDate() + 1)
      
        const formatter = new Intl.DateTimeFormat('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        button.textContent = formatter.format(date.getTime())
        col.appendChild(button)
        row.appendChild(col)



        for (let j = 0; j < 2; j++) {
            const col = document.createElement('div')
            col.classList.add('col-3')
            const button = document.createElement('button')
            button.classList.add('btn', 'btn-outline-danger', 'container')
            
            const avail_list= availability[formatDate(date)];
           
                if ( avail_list.length == 2)
                {
                    toggle_button(button)
                }
                else if( avail_list.length == 1) {
                    if ( (j+1) == avail_list[0]) {
                        toggle_button(button) 
                    }
                }
            

            button.setAttribute('data-date', formatDate(date));
            button.setAttribute('data-slot_no',  j+1 );
            button.setAttribute('onclick',  "book(event)" );


            
            button.textContent = TextContent[j]
            col.appendChild(button)
            row.appendChild(col)
        }
        container.appendChild(row)
    }
    modal_body.appendChild(container);

    async function book(e){
        console.log(e)
        const button = e.target ; 
        const date = button.dataset.date 
        const slot_no  = button.dataset.slot_no ;

        const response = await fetch(`/doctor/book/${date}/${slot_no}`)
        if ( response.ok ) {
            toggle_button(button)
        }


    }

    function toggle_button(button){
        button.classList.remove('btn-outline-danger')
        button.classList.add('btn-outline-success')
    }

   function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

</script>

{% endblock %}